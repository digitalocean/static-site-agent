<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Static Site Agent – DigitalOcean</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --do-blue: #0080ff;
            --do-blue-hover: #0069d9;
            --do-blue-light: #e6f2ff;
            --do-bg: #f5f7fa;
            --do-surface: #ffffff;
            --do-border: #e5e8eb;
            --do-text: #24292f;
            --do-text-secondary: #57606a;
            --do-success: #1a7f37;
            --do-warning-bg: #fff8e6;
            --do-warning-text: #7d4e00;
            --do-error-bg: #ffebe9;
            --do-error-text: #cf222e;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--do-bg);
            color: var(--do-text);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background: var(--do-surface);
            border-bottom: 1px solid var(--do-border);
            padding: 14px 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }

        .chat-header-logo {
            height: 28px;
            width: auto;
            display: block;
        }

        .chat-header-divider {
            width: 1px;
            height: 24px;
            background: var(--do-border);
        }

        .chat-header-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--do-text);
        }

        .chat-header-subtitle {
            font-size: 13px;
            font-weight: 400;
            color: var(--do-text-secondary);
            margin-top: 2px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .message {
            margin-bottom: 16px;
            display: flex;
            animation: messageIn 0.2s ease-out;
        }

        @keyframes messageIn {
            from { opacity: 0; transform: translateY(6px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-content {
            max-width: 75%;
            padding: 12px 16px;
            border-radius: 8px;
            word-wrap: break-word;
            font-size: 14px;
            line-height: 1.5;
        }

        .message.user .message-content {
            background: var(--do-blue);
            color: white;
        }

        .message.agent .message-content {
            background: var(--do-surface);
            color: var(--do-text);
            border: 1px solid var(--do-border);
        }

        .message.system .message-content {
            background: var(--do-warning-bg);
            color: var(--do-warning-text);
            max-width: 100%;
            text-align: center;
            font-size: 13px;
            border: none;
        }

        .message.error .message-content {
            background: var(--do-error-bg);
            color: var(--do-error-text);
            max-width: 100%;
            border: none;
        }

        .typing-indicator {
            display: none;
            padding: 12px 16px;
            background: var(--do-surface);
            border: 1px solid var(--do-border);
            border-radius: 8px;
            width: fit-content;
        }

        .typing-indicator.active {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .typing-indicator span {
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--do-text-secondary);
            animation: typing 1s ease-in-out infinite;
        }

        .typing-indicator span:nth-child(2) { animation-delay: 0.15s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.3s; }

        @keyframes typing {
            0%, 60%, 100% { opacity: 0.4; transform: scale(0.9); }
            30% { opacity: 1; transform: scale(1); }
        }

        .chat-input-container {
            padding: 16px 24px 24px;
            background: var(--do-surface);
            border-top: 1px solid var(--do-border);
            flex-shrink: 0;
        }

        .chat-input-form {
            display: flex;
            gap: 12px;
            max-width: 720px;
            margin: 0 auto;
        }

        .chat-input {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid var(--do-border);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            color: var(--do-text);
            background: var(--do-surface);
            outline: none;
            transition: border-color 0.15s, box-shadow 0.15s;
        }

        .chat-input::placeholder {
            color: var(--do-text-secondary);
        }

        .chat-input:hover {
            border-color: #b1bac4;
        }

        .chat-input:focus {
            border-color: var(--do-blue);
            box-shadow: 0 0 0 3px var(--do-blue-light);
        }

        .send-button {
            padding: 10px 20px;
            background: var(--do-blue);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            transition: background 0.15s;
        }

        .send-button:hover:not(:disabled) {
            background: var(--do-blue-hover);
        }

        .send-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .suggestions {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .suggestion-chip {
            padding: 8px 14px;
            background: var(--do-surface);
            border: 1px solid var(--do-border);
            color: var(--do-text);
            border-radius: 8px;
            font-size: 13px;
            font-family: inherit;
            cursor: pointer;
            transition: border-color 0.15s, background 0.15s, color 0.15s;
        }

        .suggestion-chip:hover {
            border-color: var(--do-blue);
            color: var(--do-blue);
            background: var(--do-blue-light);
        }

        pre {
            background: var(--do-bg);
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 10px 0;
            font-size: 13px;
            border: 1px solid var(--do-border);
        }

        code {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace;
            font-size: 13px;
        }

        .message-link {
            color: var(--do-blue);
            text-decoration: none;
            word-break: break-all;
        }

        .message-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <header class="chat-header">
        <img 
            class="chat-header-logo" 
            src="https://upload.wikimedia.org/wikipedia/commons/f/ff/DigitalOcean_logo.svg" 
            alt="DigitalOcean"
        >
        <div class="chat-header-divider" aria-hidden="true"></div>
        <div>
            <div class="chat-header-title">Static Site Agent</div>
            <div class="chat-header-subtitle">Create, edit, and deploy static sites</div>
        </div>
    </header>

    <div class="chat-messages" id="chatMessages">
        <div class="message system">
            <div class="message-content">
                Welcome. I can help you create static websites, containerize them, and deploy to DigitalOcean Spaces. What would you like to do?
            </div>
        </div>
        <div class="suggestions">
            <button type="button" class="suggestion-chip" onclick="sendSuggestion('Create a modern minimalist portfolio site')">
                Portfolio Site
            </button>
            <button type="button" class="suggestion-chip" onclick="sendSuggestion('Generate a colorful landing page for a tech startup')">
                Landing Page
            </button>
            <button type="button" class="suggestion-chip" onclick="sendSuggestion('Build a professional blog with a dark theme')">
                Blog Site
            </button>
        </div>
        <div class="typing-indicator" id="typingIndicator">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </div>

    <div class="chat-input-container">
        <form class="chat-input-form" id="chatForm">
            <input 
                type="text" 
                class="chat-input" 
                id="messageInput" 
                placeholder="Create, edit, or manage static sites—ask anything..."
                autocomplete="off"
            >
            <button type="submit" class="send-button" id="sendButton">Send</button>
        </form>
    </div>

    <script>
        const chatMessages = document.getElementById('chatMessages');
        const chatForm = document.getElementById('chatForm');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const typingIndicator = document.getElementById('typingIndicator');

        function addMessage(content, type = 'agent') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            const formattedContent = formatMessage(content);
            contentDiv.innerHTML = formattedContent;
            
            messageDiv.appendChild(contentDiv);
            chatMessages.insertBefore(messageDiv, typingIndicator);
            scrollToBottom();
        }

        function escapeHtml(text) {
            return text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;');
        }

        function formatMessage(text) {
            const urlRegex = /(https?:\/\/[^\s<>"\']+)/g;
            const urls = [];
            const withPlaceholders = text.replace(urlRegex, (url) => {
                let cleanUrl = url.replace(/[.,;:!?]+$/, '');
                // Strip trailing unbalanced closing parentheses (e.g. URL wrapped in parens)
                while (cleanUrl.endsWith(')')) {
                    const opens = (cleanUrl.match(/\(/g) || []).length;
                    const closes = (cleanUrl.match(/\)/g) || []).length;
                    if (closes > opens) {
                        cleanUrl = cleanUrl.slice(0, -1);
                    } else {
                        break;
                    }
                }
                urls.push(cleanUrl);
                return '\u0001URL' + (urls.length - 1) + '\u0001';
            });
            const escaped = escapeHtml(withPlaceholders);
            const withBreaks = escaped.replace(/\n/g, '<br>');
            const withCode = withBreaks.replace(/`([^`]+)`/g, '<code>$1</code>');
            const withLinks = withCode.replace(/\u0001URL(\d+)\u0001/g, (_, i) => {
                const url = urls[parseInt(i, 10)];
                const safeHref = escapeHtml(url).replace(/"/g, '&quot;');
                return '<a href="' + safeHref + '" target="_blank" rel="noopener noreferrer" class="message-link">' + escapeHtml(url) + '</a>';
            });
            return withLinks;
        }

        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function setLoading(isLoading) {
            sendButton.disabled = isLoading;
            messageInput.disabled = isLoading;
            typingIndicator.classList.toggle('active', isLoading);
            if (isLoading) scrollToBottom();
        }

        async function sendMessage(message) {
            if (!message.trim()) return;

            addMessage(message, 'user');
            messageInput.value = '';
            messageInput.focus();
            setLoading(true);

            try {
                const response = await fetch('/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        jsonrpc: '2.0',
                        id: Date.now().toString(),
                        method: 'message/send',
                        params: {
                            message: {
                                role: 'user',
                                parts: [{ kind: 'text', text: message }]
                            }
                        }
                    })
                });

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                const data = await response.json();
                if (data.result && data.result.artifacts && data.result.artifacts.length > 0) {
                    const responseText = data.result.artifacts[0].parts[0].text;
                    addMessage(responseText, 'agent');
                } else {
                    throw new Error('Invalid response format');
                }
            } catch (error) {
                console.error('Error:', error);
                addMessage(`Error: ${error.message}. Please make sure your GRADIENT_API_KEY is set.`, 'error');
            } finally {
                setLoading(false);
                messageInput.focus();
            }
        }

        function sendSuggestion(text) {
            messageInput.value = text;
            sendMessage(text);
        }

        chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            sendMessage(messageInput.value);
        });

        messageInput.focus();
    </script>
</body>
</html>
